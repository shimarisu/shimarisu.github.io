■syslog

/etc/syslogd.conf

#For a start, use this simplifed approach.
*.*                                     /var/log/messages
local4.*                          /var/log/ldap.log


/usr/sbin/syslogd

/var/log/ldap.log

■OpenLDAPのインストール

curl -O ftp://ftp.openldap.org/pub/OpenLDAP/openldap-release/openldap-2.4.48.tgz
tar xvf openldap-2.4.48.tgz
cd openldap-2.4.48
./configure --disable-mdb
make depend
make
make install

■OpenLDAP(設定ファイル)
/usr/local/etc/openldap/slapd.conf

directory /usr/local/var/openldap-data

adduser


http://gitpub.hatenablog.com/entry/2013/07/15/191227

OpenLDAP
https://l-w-i.net/t/openldap/conf_001.txt

\l

\c


export PGDATA=/usr/local/pgsql/data

adduser postgress


cd /usr/local/pgsql
sudo chown postgres:postgres ./data
su - postgres
cd /usr/local/pgsql/bin
./initdb -D /usr/local/pgsql/data  

Success. You can now start the database server using:
./pg_ctl -D /usr/local/pgsql/data -l logfile start



sakamotot@NDSPC7268 /etc/openldap
$ cat slapd.conf
include         /etc/openldap/schema/core.schema
include         /etc/openldap/schema/cosine.schema
include         /etc/openldap/schema/misc.schema
include         /etc/openldap/schema/inetorgperson.schema

pidfile         /var/openldap/run/slapd.pid
argsfile        /var/openldap/run/slapd.args

# Sample access control policy:
access to *
        by self write
        by users read
        by anonymous auth

#######################################################################
# BDB database definitions
#######################################################################

database        bdb
suffix          "dc=example,dc=com"
rootdn          "cn=Admin,dc=example,dc=com"
# Cleartext passwords, especially for the rootdn, should
# be avoid.  See slappasswd(8) and slapd.conf(5) for details.
# Use of strong authentication encouraged.
rootpw          secret

# The database directory MUST exist prior to running slapd AND
# should only be accessible by the slapd and slap tools.
# Mode 700 recommended.
directory       /var/openldap/openldap-data
# Indices to maintain
index   objectClass     eq
index   uid     eq
index   cn      sub
index   mail    sub



sudo apt-get update
sudo apt-get -y install libnss-ldap libpam-ldap ldap-utils nscd

sudo apt-get install zlib1g-dev



https://www.postgresql.org/ftp/source/v12.0/



sudo apt install libreadline-dev
sudo apt-get install zlib1g-dev



tar xvf ./postgresql-12.0.tar.gz

./configure --with-ldap
make
make install



cd /usr/local/pgsql/bin


PGDATA=/usr/local/pgsql/data
export PGDATA

./pg_ctl start
pg_ctl: directory "/usr/local/pgsql/data" is not a database cluster directory



Command 'psql' not found, but can be installed with:

apt install postgresql-client-common
Please ask your administrator.





■ldap認証の書き方はこちら
https://www.postgresql.org/docs/12/auth-ldap.html

ldap ldapserver=localhot ldapprefix="cn=" ldapsuffix=",dc=example,dc=com"

2019-10-18 15:53:56.722 JST [3032] LOG:  authentication method "ldap" requires argument "ldapbasedn", "ldapprefix", or "ldapsuffix" to be set



dn: cn=shimarisu,dc=example,dc=com
objectclass: top
objectclass: person
objectclass: organizationalperson
objectclass: inetorgperson
uid: shimarisu
cn: shimarisu
sn: しま
givenname: りす
mail: shimarisu@example.com
userPassword: {SSHA}OkxU+Qhn7rn/fgallQ3STOrOMeANDVxp

dn: cn=admin,dc=example,dc=com
objectclass: top
objectclass: person
objectclass: organizationalperson
objectclass: inetorgperson
cn: admin
sn: PostgresDB管理者
mail: admin@example.com
userPassword: secret123


ldapadd -f dmin.ldif -D cn=Manager,dc=example,dc=com -W -v -c





#uid: pg_admin
#givenname: りす




ldapadd -f gorilla.ldif -D cn=Manager,dc=example,dc=com -W -v -c








■PostgreSQL


データベースの作成
createdb mydb


create table address_book(
  "id" serial,
  "name" varchar(32) not null,
  "email" varchar(128) not null
);


insert into address_book (name,email)values('猿','saru@exaple.com');
insert into address_book (name,email)values('ゴリラ','gorilla@example.com');
insert into address_book (name,email)values('チンパンジー','chinpanzee@example.com');





https://eng-entrance.com/postgresql-role#i
ロールの作成
CREATE ROLE saru WITH LOGIN PASSWORD 'onigiri';
CREATE ROLE gorilla WITH LOGIN;
CREATE ROLE admin WITH SUPERUSER LOGIN;
•LOGIN
•SUPERUSER
•CREATEDB
•CREATEROLE
•REPLICATION
•PASSWORD




確認
\du

CREATE DATABASE mydb OWNER saru;

/usr/local/pgsql/bin/psql -U saru -d mydb



/usr/local/pgsql/data/pg_hba.conf

# TYPE  DATABASE        USER            ADDRESS                 METHOD

# "local" is for Unix domain socket connections only
local   all             all                                     password
# IPv4 local connections:
host    all             all             127.0.0.1/32            password
# IPv6 local connections:
host    all             all             ::1/128                 password
# Allow replication connections from localhost, by a user with the
# replication privilege.
local   replication     all                                     trust
host    replication     all             127.0.0.1/32            trust
host    replication     all             ::1/128                 trust

host all all 127.0.0.1/32 ldap "ldap://192.168.1.1/dc=example,dc=org;uid=;,ou=Users,dc=example,dc=org"

https://takaki-web.media-as.org/blog/postgresql306e8a8d8a3c3092ldap3059308b/


host myDB myUser localhost ldap ldapserver="192.168.10.1" ldapbasedn="DC=companygroup,DC=priv" ldapbinddn="cn=LDAP - Lecture,ou=Users,ou=Specials Objects,dc=companygroup,dc=priv" ldapbindpasswd="ldapPassWord" ldapsearchattribute="sAMAccountName"

PostgreSQLの公式ドキュメント
https://www.sraoss.co.jp/PostgreSQL/Manual/document/9.5/auth-methods.html


■SSHサーバーを起動する
sudo service ssh restart




https://qiita.com/masoo/items/8ebc51a6a9f32417d4a3

sudo apt update
sudo apt dist-upgrade
sudo apt autoremove



ldapsearch -D cn=Manager,dc=example,dc=com -b "dc=example,dc=com" -x -w secret "(cn=saru)" cn mail
ldapsearch -D cn=Manager,dc=example,dc=com -b "dc=example,dc=com" -x -w secret "(cn=saru)" cn userPassword



ldapadd -f saru.ldif -D cn=Manager,dc=example,dc=com -W -v -c
ldapdelete -x -D cn=Manager,dc=example,dc=com -w secret "cn=saru,dc=example,dc=com"
ldapdelete -x -D cn=Manager,dc=example,dc=com -w secret "cn=gorrila,dc=example,dc=com"

dn: dc=example,dc=com
objectClass: dcObject
objectClass: organization
dc: example
o: shimarisudan


dn: cn=saru,dc=example,dc=com
objectclass: top
objectclass: person
objectclass: organizationalperson
objectclass: inetorgperson
uid: saru
cn: saru
sn: 猿
givenname: おさる
mail: saru@example.com
userPassword: {SSHA}CBfGgrhw/GFYgi/JAD4gVvvXa0e+Ds68

dn: cn=gorrila,dc=example,dc=com
objectclass: top
objectclass: person
objectclass: organizationalperson
objectclass: inetorgperson
uid: gorilla
cn: gorilla
sn: ゴリラ
givenname: マウンテン
mail: gollira@example.com
userPassword: {SSHA}LFnJIAs2i5Irp+ROViYuPXv9YYWPQwLm

